<!DOCTYPE html>
<html>
<head>
    <title>Image Text Extractor with Puter AI</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        /* ... your existing CSS unchanged ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>Image Text Extractor</h1>
        <p class="subtitle">Upload any image and extract text using Puter AI</p>

        <!-- Upload Section -->
        <div class="upload-area" id="dropZone">
            <div class="upload-icon"></div>
            <h3>Drag & Drop Image Here</h3>
            <p>or</p>
            <input type="file" id="fileInput" accept="image/*">
            <label for="fileInput" class="file-label">Choose File</label>
            <p style="color: #666; margin-top: 10px; font-size: 14px;">
                Supported: JPG, PNG, GIF, BMP, WebP (Max: 10MB)
            </p>
        </div>

        <!-- Preview Section -->
        <div class="preview-section">
            <img id="imagePreview" alt="Image Preview">
            <div id="noPreview">No image selected</div>
        </div>

        <!-- Status Messages -->
        <div id="status" class="status"></div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button onclick="sendImageToServer()" id="extractBtn" disabled>Extract Text</button>
            <button onclick="clearAll()" style="background: #6c757d;">Clear All</button>
            <button onclick="copyToClipboard()" id="copyBtn" style="background: #28a745; display: none;">
                Copy Text
            </button>
            <button onclick="downloadText()" id="downloadBtn" style="background: #17a2b8; display: none;">
                ⬇️ Download Text
            </button>
        </div>

        <!-- Results Section -->
        <div class="result-section" id="resultSection">
            <h3>Extracted Text:</h3>
            <textarea id="extractedText" placeholder="Extracted text will appear here..." readonly></textarea>
            <div class="stats">
                <div class="stat-item" id="charCount">Characters: 0</div>
                <div class="stat-item" id="wordCount">Words: 0</div>
                <div class="stat-item" id="lineCount">Lines: 0</div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="info-box">
            <strong>How it works:</strong>
            <p>1. Upload any image containing text (screenshot, photo, document, etc.)</p>
            <p>2. Click "Extract Text" to use Puter AI's OCR technology</p>
            <p>3. Copy or download the extracted text</p>
            <p><em>Note: Puter AI processes images locally in your browser for privacy.</em></p>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const imagePreview = document.getElementById('imagePreview');
        const noPreview = document.getElementById('noPreview');
        const extractedText = document.getElementById('extractedText');
        const extractBtn = document.getElementById('extractBtn');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resultSection = document.getElementById('resultSection');
        const status = document.getElementById('status');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const lineCount = document.getElementById('lineCount');

        let currentImageData = null;

        // ----------------------
        // Initialize WebSocket
        // ----------------------
        const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsProtocol}://${window.location.host}`);

        ws.addEventListener('open', () => {
            console.log('WebSocket connected');
        });

        ws.addEventListener('message', async (event) => {
            const msg = JSON.parse(event.data);

            if (msg.action === 'extractBase64' && msg.image) {
                currentImageData = msg.image;
                previewImageFromDataURL(currentImageData);
                await extractTextFromData(currentImageData);
            }
        });

        // ----------------------
        // Image preview
        // ----------------------
        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.match('image.*')) return showStatus('Please select an image file', 'error');
            if (file.size > 10 * 1024 * 1024) return showStatus('File size too large', 'error');

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                previewImageFromDataURL(currentImageData);
            };
            reader.readAsDataURL(file);
        }

        function previewImageFromDataURL(dataURL) {
            imagePreview.src = dataURL;
            imagePreview.style.display = 'block';
            noPreview.style.display = 'none';
            extractBtn.disabled = false;
            showStatus('Image ready. Click "Extract Text" to process.', 'success');
        }

        // ----------------------
        // Send image to server via WebSocket
        // ----------------------
        function sendImageToServer() {
            if (!currentImageData) return showStatus('No image selected', 'error');

            showStatus('<span class="loading"></span> Sending image to server...', 'processing');

            ws.send(JSON.stringify({
                action: 'uploadImage',
                image: currentImageData
            }));

            showStatus('Image sent. Waiting for server to process...', 'success');
        }

        // ----------------------
        // Extract text using Puter AI locally
        // ----------------------
        async function extractTextFromData(dataURL) {
            showStatus('<span class="loading"></span> Extracting text...', 'processing');
            extractBtn.disabled = true;
            extractedText.value = 'Processing...';
            resultSection.style.display = 'block';

            try {
                const text = await puter.ai.img2txt({
                    source: dataURL,
                    provider: 'aws-textract'
                });

                if (text && text.trim()) {
                    extractedText.value = text;
                    updateStats(text);
                    showStatus('Text extraction successful!', 'success');
                    copyBtn.style.display = 'inline-block';
                    downloadBtn.style.display = 'inline-block';
                } else {
                    extractedText.value = 'No text detected in image.';
                    showStatus('No text found in image.', 'error');
                }
            } catch (err) {
                console.error(err);
                extractedText.value = 'Error: ' + err.message;
                showStatus('Failed to extract text: ' + err.message, 'error');
            } finally {
                extractBtn.disabled = false;
            }
        }

        async function extractText() {
            if (!currentImageData) return showStatus('No image selected', 'error');
            await extractTextFromData(currentImageData);
        }

        // ----------------------
        // Status helper
        // ----------------------
        function showStatus(message, type='processing') {
            status.innerHTML = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
            if (type === 'success') {
                setTimeout(() => status.style.display='none', 3000);
            }
        }

        // ----------------------
        // Stats
        // ----------------------
        function updateStats(text) {
            charCount.textContent = `Characters: ${text.length}`;
            wordCount.textContent = `Words: ${text.trim().split(/\s+/).length}`;
            lineCount.textContent = `Lines: ${text.split('\n').length}`;
        }

        // ----------------------
        // Copy / Download
        // ----------------------
        async function copyToClipboard() {
            try { await navigator.clipboard.writeText(extractedText.value); showStatus('Copied!', 'success'); }
            catch { showStatus('Failed to copy', 'error'); }
        }

        function downloadText() {
            const text = extractedText.value;
            if (!text.trim()) return showStatus('No text to download', 'error');
            const blob = new Blob([text], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `extracted-text-${Date.now()}.txt`;
            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
            showStatus('Text downloaded!', 'success');
        }

        // ----------------------
        // Clear all
        // ----------------------
        function clearAll() {
            fileInput.value = '';
            currentImageData = null;
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            noPreview.style.display = 'block';
            extractedText.value = '';
            resultSection.style.display = 'none';
            copyBtn.style.display = 'none';
            downloadBtn.style.display = 'none';
            extractBtn.disabled = true;
            status.style.display = 'none';
            charCount.textContent='Characters: 0';
            wordCount.textContent='Words: 0';
            lineCount.textContent='Lines: 0';
            showStatus('Cleared. Ready for new image.', 'success');
        }

        // ----------------------
        // Drag and drop
        // ----------------------
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault(); dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (!files.length) return;
            const mockEvent = { target: { files: [files[0]] }};
            previewImage(mockEvent);
        });

        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', previewImage);

        // ----------------------
        // Init
        // ----------------------
        document.addEventListener('DOMContentLoaded', () => showStatus('Ready to extract text from images', 'success'));

        // ----------------------
        // Window API for external scripts
        // ----------------------
        window.PuterTextExtractor = {
            extractFromDataURL: extractTextFromData,
            extractFromFile: async file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = async e => {
                        try { const text = await puter.ai.img2txt({source:e.target.result,provider:'aws-textract'}); resolve({success:true,text:text||''}); }
                        catch(err){ resolve({success:false,error:err.message}); }
                    };
                    reader.readAsDataURL(file);
                });
            },
            getText: ()=>extractedText.value,
            clear: clearAll
        };
    </script>
</body>
</html>
